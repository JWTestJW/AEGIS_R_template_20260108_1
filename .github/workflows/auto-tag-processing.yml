name: Auto Tag Processing

on:
  push:
    branches:
      - main

permissions:
  contents: write # リポジトリにタグをプッシュするために必要

jobs:
  tag-processing:
    runs-on: ubuntu-latest
    steps:
      - name: Check if repository is a template
        id: check_template
        run: |
          repo_name="${GITHUB_REPOSITORY##*/}"
          if echo "$repo_name" | grep -i "template" ; then
            echo "This repository is a template. Exiting."
            exit 0
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check tags existence
        id: check_tags
        run: |
          TAGS=$(git tag)
          if [ -z "$TAGS" ]; then
            echo "No tags found. Exiting."
            exit 0
          fi
          if [ "$TAGS" = "v0.0.0" ]; then
            echo "Only v0.0.0 tag found. Exiting."
            exit 0
          fi

      - name: Get related PR labels
        id: pr_labels
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = process.env.GITHUB_SHA;
            // mainブランチにマージされたPRを検索
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "closed",
              base: "main",
              sort: "updated",
              direction: "desc",
              per_page: 10
            });
            // このコミットを含むPRを探す
            const pr = prs.find(pr => pr.merge_commit_sha === commitSha);
            if (!pr) {
              core.info("No related PR found.");
              core.setOutput("labels", "[]");
              return;
            }
            const labels = pr.labels.map(l => l.name);
            core.setOutput("labels", JSON.stringify(labels));

      - name: Process Labels and Tag
        id: process-labels-and-tag
        uses: actions/github-script@v7
        with:
          script: |
            const labels = JSON.parse('${{ steps.pr_labels.outputs.labels }}');
            let bumpType = null;
            if (labels.includes('release:major')) bumpType = 'major';
            else if (labels.includes('release:minor')) bumpType = 'minor';
            else if (labels.includes('release:patch')) bumpType = 'patch';

            if (!bumpType) {
              core.info('No release label found. Exiting.');
              return;
            }
            core.info(`Bump type detected: ${bumpType}`);

            // 最新のタグを取得
            const tags = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            let latestTag = tags.data.length > 0 ? tags.data[0].name : 'v0.0.0';
            core.info(`Latest tag: ${latestTag}`);

            let [major, minor, patch] = latestTag.replace(/^v/, '').split('.').map(x => parseInt(x) || 0);
            if (bumpType === 'major') { major++; minor = 0; patch = 0; }
            else if (bumpType === 'minor') { minor++; patch = 0; }
            else if (bumpType === 'patch') { patch++; }

            const newTag = `v${major}.${minor}.${patch}`;
            core.info(`New tag: ${newTag}`);

            // 新しいタグを作成
            const commitSha = process.env.GITHUB_SHA;
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${newTag}`,
              sha: commitSha
            });
            core.setOutput('new_tag', newTag);

      - name: Trigger Auto Deploy Workflow
        if: ${{ steps.process-labels-and-tag.outputs.new_tag != '' }}
        uses: actions/github-script@v7
        env:
          NEW_TAG: ${{ steps.process-labels-and-tag.outputs.new_tag }}
        with:
          script: |
            // タグ名を取得
            const tag = process.env.NEW_TAG;
            if (!tag) {
              core.setFailed("No new tag found to trigger deploy.");
              return;
            }
            console.log(`Triggering auto-deploy-use-selfhosted-runner.yml for tag: ${tag}`);
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-deploy-use-selfhosted-runner.yml',
              ref: `refs/tags/${tag}`
            });
