name: Auto Tag Processing

on:
  push:
    branches:
      - main

permissions:
  contents: write # リポジトリにタグをプッシュするために必要

jobs:
  check-template:
    runs-on: ubuntu-latest
    steps:
      - name: Check if repository is a template
        run: |
          repo_name="${GITHUB_REPOSITORY##*/}"
          if echo "$repo_name" | grep -i "template" ; then
            echo "Repository name contains 'template', cancelling workflow."
            # 78で終了することでワークフローを「キャンセル」状態にし、後続のワークフロー（workflow_runトリガー）は実行されません（エラーではありません）。
            exit 78
          fi

  tag-processing:
    needs: check-template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # git describeを実行するためにすべての履歴を取得

      - name: Set up Python
        uses: actions/setup-python@v4

      - name: Install GitHub CLIP
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Get related PR labels
        id: pr_labels
        run: |
          # 最新コミットSHA取得
          COMMIT_SHA=$(git rev-parse HEAD)
          # mainの該当PR取得
          PR_JSON=$(gh pr list --state merged --base main --search $COMMIT_SHA --json number,labels --limit 1)
          echo "PR_JSON=$PR_JSON" >> $GITHUB_ENV
          LABELS=$(echo "$PR_JSON" | python3 -c "import sys, json; arr=json.load(sys.stdin); print(json.dumps(arr[0]['labels']) if arr and 'labels' in arr[0] else '[]')")
          echo "PR_LABELS=$LABELS" >> $GITHUB_ENV

      - name: Process Labels and Tag
        env:
          PR_LABELS: ${{ env.PR_LABELS }}
        run: |
          python3 -c "
          import os
          import json
          import subprocess
          import sys

          # PRラベルを取得
          labels_json = os.environ.get('PR_LABELS', '[]')
          try:
              labels = json.loads(labels_json)
          except:
              labels = []

          label_names = [l['name'] for l in labels]
          bump_type = None

          # ラベルを走査
          # ロジック: release:major, release:minor, release:patch を確認
          # 優先順位: major > minor > patch
          if 'release:major' in label_names:
              bump_type = 'major'
          elif 'release:minor' in label_names:
              bump_type = 'minor'
          elif 'release:patch' in label_names:
              bump_type = 'patch'

          # 一致するラベルがない場合は終了
          if not bump_type:
              print('No release label found (release:major, release:minor, release:patch). Exiting.')
              # 78で終了することでワークフローを「キャンセル」状態にし、後続のワークフロー（workflow_runトリガー）は実行されません（エラーではありません）。
              sys.exit(78)

          print(f'Bump type detected: {bump_type}')

          # 最新のタグを取得
          # git describe --tags --abbrev=0: 現在のコミットから履歴を遡り、到達可能な最も近いタグを取得します
          try:
              latest_tag = subprocess.check_output(['git', 'describe', '--tags', '--abbrev=0'], stderr=subprocess.DEVNULL).decode().strip()
          except:
              latest_tag = 'v0.0.0'

          print(f'Latest tag: {latest_tag}')

          # バージョン vX.Y.Z を解析
          if latest_tag.startswith('v'):
              version_str = latest_tag[1:]
          else:
              version_str = latest_tag

          parts = version_str.split('.')
          # X.Y.Z形式を保証
          while len(parts) < 3:
              parts.append('0')

          try:
              major = int(parts[0])
              minor = int(parts[1])
              patch = int(parts[2])
          except ValueError:
              print(f'Error: Could not parse version numbers from tag {latest_tag}')
              sys.exit(1)

          # セマンティック バージョニング (SemVer) ロジックを適用
          # release:major -> v(X+1).0.0 (下位バージョンは0にリセット)
          # release:minor -> vX.(Y+1).0 (下位バージョンは0にリセット)
          # release:patch -> vX.Y.(Z+1)
          if bump_type == 'major':
              major += 1
              minor = 0
              patch = 0
          elif bump_type == 'minor':
              minor += 1
              patch = 0
          elif bump_type == 'patch':
              patch += 1

          new_tag = f'v{major}.{minor}.{patch}'
          print(f'New tag: {new_tag}')

          # プッシュ用にgitを設定
          subprocess.run(['git', 'config', 'user.name', 'github-actions[bot]'], check=True)
          subprocess.run(['git', 'config', 'user.email', 'github-actions[bot]@users.noreply.github.com'], check=True)

          # 新しいタグをプッシュ
          try:
              subprocess.run(['git', 'tag', new_tag], check=True)
              subprocess.run(['git', 'push', 'origin', new_tag], check=True)
              print(f'Successfully pushed tag {new_tag}')
          except subprocess.CalledProcessError as e:
              print(f'Failed to push tag: {e}')
              sys.exit(1)
          "
