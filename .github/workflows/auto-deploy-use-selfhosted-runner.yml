# ================================================
# 機能概要
# -----------------------------------------------
# このワークフローはSelf-Hostedランナー上で、
# リポジトリ名から環境情報を解析し、タグ作成時または手動実行時に
# 資材を指定パスへデプロイします。
#
# 実行条件：
# ・"Auto Tag Processing"ワークフロー成功時（自動実行）
# 　- 対象コミットにタグが付与されている場合のみデプロイ
# ・workflow_dispatch（手動実行）
# 　- 選択したブランチまたはタグの資材をデプロイ
#
# 主な処理：
# ・リポジトリ名からデプロイ先情報を抽出
# ・テンプレートパスを変数で置換し配信先決定
# 下記ファイルが配信対象：
#  renv.lock
#  .Rファイル（renv配下除く）（Scriptsフォルダへ）
# ・エラー時は即時中断、全処理ログはActionsで確認可能
# ・最後にcheckout資材とログをクリーンアップ
# ================================================

name: Auto Deploy (Self-Hosted)

permissions:
  contents: read

on:
  workflow_dispatch: {}

jobs:
  analyze-repository-name:
    runs-on: ubuntu-latest
    outputs:
      repo_type: ${{ steps.parse-name.outputs.repo_type }}
      molecule_no: ${{ steps.parse-name.outputs.molecule_no }}
      study_no: ${{ steps.parse-name.outputs.study_no }}
      reporting_event: ${{ steps.parse-name.outputs.reporting_event }}
      env_name: ${{ steps.parse-name.outputs.env_name }}
    steps:
      - name: Parse Repository Name
        id: parse-name
        run: |
          # Get pure repository name (remove owner/)
          REPO_NAME=$(echo "${{ github.repository }}" | awk -F '/' '{print $2}')
          echo "Analyzing Repository Name: $REPO_NAME"

          IFS='-' read -r -a parts <<< "$REPO_NAME"
          PARTS_LEN=${#parts[@]}

          # 3rd part (index 2) determines type S or M
          # Example S: AEGIS-PRD-S-RO1234567-STD0001-ReportingEvent1-dev
          # Example M: AEGIS-ZTEST-M-RO1234567-ReportingEvent2-dev

          if [ "$PARTS_LEN" -lt 3 ]; then
            echo "Error: Repository name must have at least 3 parts, got $PARTS_LEN."
            exit 1
          fi

          TYPE="${parts[2]}"

          if [ "$TYPE" == "S" ]; then
            if [ "$PARTS_LEN" -lt 7 ]; then
              echo "Error: Type S repository name must have at least 7 parts, got $PARTS_LEN."
              exit 1
            fi
            echo "Detected Type: S (Study)"
            MOLECULE_NO="${parts[3]}"
            STUDY_NO="${parts[4]}"
            EVENT_NAME="${parts[5]}"
            ENV_NAME="${parts[6]}"

            echo "repo_type=S" >> $GITHUB_OUTPUT            
            echo "molecule_no=$MOLECULE_NO" >> $GITHUB_OUTPUT
            echo "study_no=$STUDY_NO" >> $GITHUB_OUTPUT
            echo "reporting_event=$EVENT_NAME" >> $GITHUB_OUTPUT
            echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT

          elif [ "$TYPE" == "M" ]; then
            if [ "$PARTS_LEN" -lt 6 ]; then
              echo "Error: Type M repository name must have at least 6 parts, got $PARTS_LEN."
              exit 1
            fi
            echo "Detected Type: M (Molecule)"
            MOLECULE_NO="${parts[3]}"
            EVENT_NAME="${parts[4]}"
            ENV_NAME="${parts[5]}"

            echo "repo_type=M" >> $GITHUB_OUTPUT            
            echo "molecule_no=$MOLECULE_NO" >> $GITHUB_OUTPUT
            echo "study_no=" >> $GITHUB_OUTPUT
            echo "reporting_event=$EVENT_NAME" >> $GITHUB_OUTPUT
            echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT

          else
            echo "Error: Unknown repository name pattern. Type '$TYPE' is not S or M."
            exit 1
          fi

  deploy:
    needs: analyze-repository-name
    # Self-Hosted ランナーを指定（ラベルは環境に合わせて調整してください）
    runs-on:
      [
        self-hosted,
        linux,
        "${{ needs.analyze-repository-name.outputs.env_name }}"
      ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: checkoutDir
          ref: ${{ github.ref }}

      - name: Prepare and Copy to Delivery Directory
        env:
          DELIVERY_DEST_S: ${{ vars.DELIVERY_DEST_S }}
          DELIVERY_DEST_M: ${{ vars.DELIVERY_DEST_M }}
          REPO_TYPE: ${{ needs.analyze-repository-name.outputs.repo_type }}
          MOLECULE_NO: ${{ needs.analyze-repository-name.outputs.molecule_no }}
          STUDY_NO: ${{ needs.analyze-repository-name.outputs.study_no }}
          REPORTING_EVENT: ${{ needs.analyze-repository-name.outputs.reporting_event }}
        run: |
          set -e
          LOG_FILE="deploy_report.log"
          START_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          echo "========================================" > "$LOG_FILE"
          echo "Deployment Report" >> "$LOG_FILE"
          echo "Start Time: $START_TIME" >> "$LOG_FILE"

          # 1. 配信先パスのテンプレートを選択
          if [ "$REPO_TYPE" = "S" ]; then
            DEST_TEMPLATE="$DELIVERY_DEST_S"
          elif [ "$REPO_TYPE" = "M" ]; then
            DEST_TEMPLATE="$DELIVERY_DEST_M"
          else
            echo "Error: Unknown repo_type: $REPO_TYPE" | tee -a "$LOG_FILE"
            exit 1
          fi

          # DEST_TEMPLATEが空かどうかをチェック
          if [ -z "$DEST_TEMPLATE" ]; then
            echo "Error: 配信先テンプレート(DELIVERY_DEST_S/M)が未設定です。" | tee -a "$LOG_FILE"
            exit 1
          fi

          # 2. テンプレート変数を置換
          DEST_PATH="$DEST_TEMPLATE"
          DEST_PATH="${DEST_PATH//<MoleculeNo>/$MOLECULE_NO}"
          DEST_PATH="${DEST_PATH//<StudyNo>/$STUDY_NO}"
          DEST_PATH="${DEST_PATH//<ReportingEventName>/$REPORTING_EVENT}"

          # DEST_PATHが存在するかどうかをチェック
          if [ ! -d "$DEST_PATH" ]; then
            echo "Error: 配信先ディレクトリが存在しません: $DEST_PATH" | tee -a "$LOG_FILE"
            exit 1
          fi

          echo "Target: $DEST_PATH" >> "$LOG_FILE"
          echo "========================================" >> "$LOG_FILE"

          # 3-2. Scriptsフォルダの存在確認と作成
          SCRIPTS_DIR="$DEST_PATH/Scripts"
          if [ -d "$SCRIPTS_DIR" ]; then
            echo "Removing existing Scripts directory: $SCRIPTS_DIR" | tee -a "$LOG_FILE"
            rm -rf "$SCRIPTS_DIR"
          fi
          mkdir -p "$SCRIPTS_DIR"

          # 3-3. checkoutDir配下の全ての.Rファイルを再帰的に検索し、renv配下を除外してScriptsへコピー
          echo "Copying .R files to Scripts..." | tee -a "$LOG_FILE"
          find checkoutDir -type f -name "*.R" ! -path "*/renv/*" -exec cp {} "$SCRIPTS_DIR/" \;
          if [ $? -ne 0 ]; then
            echo "Error: Failed to copy .R files." | tee -a "$LOG_FILE"
            exit 1
          fi

          # 3-4. renv.lockをコピー
          if [ -f "checkoutDir/renv.lock" ]; then
            cp "checkoutDir/renv.lock" "$DEST_PATH/"
            if [ $? -ne 0 ]; then
              echo "Error: Failed to copy renv.lock." | tee -a "$LOG_FILE"
              exit 1
            fi
          else
            echo "Info: renv.lock not found in checkoutDir." | tee -a "$LOG_FILE"
          fi

          END_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          echo "End Time: $END_TIME" >> "$LOG_FILE"
          echo "========================================" >> "$LOG_FILE"
          echo "Deployment completed successfully." | tee -a "$LOG_FILE"
          cat "$LOG_FILE"

          # checkoutDirのクリーンアップ
          echo "Cleaning up checkoutDir..."
          rm -rf checkoutDir

          # ログファイルの削除
          rm "$LOG_FILE"
