name: Repository Initialization

permissions:
  contents: write
  pull-requests: write

# 受信側: Repo Factory からの dispatch イベントを受け取る
on:
  repository_dispatch:
    types: [repo-init]

jobs:
  initialize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 全ての履歴とブランチを取得してチェックに使用

      - name: 初期化済みチェック
        run: |
          # devブランチが既に存在するかチェック
          if git show-ref --verify --quiet refs/remotes/origin/dev; then
            echo "⚠️ devブランチが既に存在するため、初期化処理をスキップします。"
            exit 0
          fi
          echo "✅ 初期化未実施を確認しました。処理を開始します。"

      - name: Configure Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: CODEOWNERSファイルの作成
        run: |
          CODE_OWNER="${{ github.event.client_payload.codeowner }}"
          TEAM_SLUG="${{ github.event.client_payload.team_slug }}"
          STUDY_NO="${{ github.event.client_payload.study_no }}"

          echo "リポジトリ初期化パラメータ:"
          echo "  Code Owner: $CODE_OWNER"
          echo "  Team Slug : $TEAM_SLUG"
          echo "  Study No  : $STUDY_NO"

          # 以前のファイルがあれば削除 (初期化)
          rm -f .github/CODEOWNERS

          # CODEOWNERS ファイルの生成
          # 渡されたパラメータ($CODE_OWNER)は、カンマ区切りの文字列です
          # 呼び出し元で検証済みのため、ここでは単純にカンマで分割し、@を付与して並べます
          # xargs を使うことで、カンマ前後の不要な空白は自動的に削除されます

          # カンマをスペースに変換し、xargsで整形（前後空白削除）
          # Githubユーザー名に空白は含まれないため、xargsの空白圧縮も問題になりません
          CLEAN_OWNERS=$(echo "$CODE_OWNER" | tr ',' ' ' | xargs)

          # スペース区切りになったリストをループして @ を付与
          FORMATTED_OWNERS=""
          for owner in $CLEAN_OWNERS; do
            FORMATTED_OWNERS="$FORMATTED_OWNERS @$owner"
          done

          echo "# This file is automatically generated by repo-init workflow" > .github/CODEOWNERS
          echo "*" $FORMATTED_OWNERS >> .github/CODEOWNERS

          echo "✅ .github/CODEOWNERS を生成しました"
          cat .github/CODEOWNERS

      - name: 変更をコミットしてMainにプッシュ
        run: |
          git add .github/CODEOWNERS
          git commit -m "chore: initialize repository (CODEOWNERS)"
          git push origin HEAD:main

      - name: ブランチの作成 (dev, qa)
        run: |
          # main から dev, qa 分岐を作成
          git checkout main

          # dev branch
          git checkout -b dev
          git push origin dev
          echo "✅ devブランチを作成しました"

          # qa branch
          git checkout -b qa
          git push origin qa
          echo "✅ qaブランチを作成しました"
